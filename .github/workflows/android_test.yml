name: Android Test

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_TOOLS:    "4333796"
      ANDROID_SDK_ID:    "system-images;android-28;google_apis;x86_64"
      EMULATOR_NAME:    "emu"

    steps:
      - uses: actions/checkout@v1
#      - uses: actions/setup-node@v1
#        with:
#          node-version: '12.x'
#          registry-url: 'https://registry.npmjs.org'
#
      - name: set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

#      - name: BuildCapacitorPlugin(This plugin itself)
#        run: |
#          npm install
#          npm run build
#
#      - name: Insatall Quasar
#        run: cd demo && yarn install
#
#      - name: Build with Quasar
#        run: cd demo && npx quasar build --mode capacitor --target android

      - name: Install Android sdkmanager
        run: |
          sudo mkdir -p /root/.android && sudo touch /root/.android/repositories.cfg
          wget --quiet --output-document=android-sdk.zip https://dl.google.com/android/repository/sdk-tools-linux-${ANDROID_SDK_TOOLS}.zip
          sudo unzip -d $ANDROID_HOME android-sdk.zip > /dev/null

      - name: Install Android image
        run: |
          echo "Install Android image"
          echo "y" | sudo $ANDROID_HOME/tools/bin/sdkmanager --install "system-images;android-28;google_apis;x86_64" > /dev/null 2>&1

      - name: Start AVD
        run: |
          sudo $ANDROID_HOME/platform-tools/adb devices
          echo "Creating emulator"
          echo "no" | sudo $ANDROID_HOME/tools/bin/avdmanager create avd -n emu -k "system-images;android-28;google_apis;x86_64" -f -p $HOME/.android/avd/emu
          echo "ls $HOME/.android/avd"
          sudo ls $HOME/.android/avd
          echo "ls $HOME/.android/avd/emu"
          sudo ls $HOME/.android/avd/emu
          echo "Installed emulator list"
          sudo $ANDROID_HOME/tools/bin/sdkmanager --list
          echo "Create emulator list"
          sudo export ANDROID_SDK_HOME=$HOME/.android/avd/emu
          sudo $ANDROID_HOME/emulator/emulator -list-avds
          echo "Boot emulator"
          sudo $ANDROID_HOME/emulator/emulator -avd ${EMULATOR_NAME} -no-snapshot
          sudo $ANDROID_HOME/emulator/emulator -avd ${EMULATOR_NAME} -no-snapshot > /dev/null 2>&1 &
          sudo $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done; input keyevent 82'
          sudo $ANDROID_HOME/platform-tools/adb kill-server
          sudo $ANDROID_HOME/platform-tools/adb devices
          echo "Emulator started"

      - name: Install App to emulator
        run: sudo $ANDROID_HOME/platform-tools/adb install /home/runner/work/capacitor-alarm-notification/capacitor-alarm-notification/demo/dist/capacitor/android/app-release-unsigned.apk

      - name: Set up Appium
        run: sudo npm install appium -g
#
      - name: Run Appium Server
        run: sudo appium --log-timestamp --log-no-colors --allow-insecure chromedriver_autodownload > appium.log &

#      - name: Build with Gradle
#        run: cd demo/src-capacitor/android/ && gradle compileJava
#        continue-on-error: true

#      - name: Upload logs
#        uses: actions/upload-artifact@v1
#        with:
#          name: appium.log
#          path: appium.log
#
#      - name: Upload screenshots
#        uses: actions/upload-artifact@v1
#        with:
#          name: screenshots
#          path: screenshots
